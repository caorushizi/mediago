name: Make MediaGo Docker Image

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build Docker Image
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            arch: amd64
            platform: linux/amd64
          - runner: ubuntu-22.04-arm
            arch: arm64
            platform: linux/arm64

    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - uses: pnpm/action-setup@v4
        with:
          version: "10.15.0"
          run_install: false
          standalone: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.19.5"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm release:server

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: registry.cn-beijing.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Docker meta
        id: meta
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG_NAME="${GITHUB_REF#refs/tags/}"

            # å¦‚æœæ˜¯ beta ç‰ˆæœ¬ï¼Œåªæ¨é€ tag
            if [[ "${TAG_NAME}" == *"beta"* ]]; then
              TAGS="registry.cn-beijing.aliyuncs.com/caorushizi/mediago:${TAG_NAME}-${{ matrix.arch }}"
            else
              # æ­£å¼ç‰ˆæœ¬ï¼Œæ¨é€ tag å’Œ latest
              TAGS="registry.cn-beijing.aliyuncs.com/caorushizi/mediago:latest-${{ matrix.arch }}\nregistry.cn-beijing.aliyuncs.com/caorushizi/mediago:${TAG_NAME}-${{ matrix.arch }}"
            fi
          else
            # é tag è§¦å‘ï¼Œåªæ¨é€ dev ç‰ˆæœ¬
            DEV_TAG="dev-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
            TAGS="registry.cn-beijing.aliyuncs.com/caorushizi/mediago:${DEV_TAG}-${{ matrix.arch }}"
          fi

          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo -e "$TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./apps/server
          platforms: ${{ matrix.platform }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create-manifest:
    name: Create Multi-Arch Manifest
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: registry.cn-beijing.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Create and push multi-arch manifest
        run: |
          IMAGE=registry.cn-beijing.aliyuncs.com/caorushizi/mediago

          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG_NAME="${GITHUB_REF#refs/tags/}"

            # åˆ›å»º tag é•œåƒ
            docker buildx imagetools create -t ${IMAGE}:${TAG_NAME} \
              ${IMAGE}:${TAG_NAME}-amd64 \
              ${IMAGE}:${TAG_NAME}-arm64

            # å¦‚æœä¸æ˜¯ betaï¼Œåˆ›å»º latest
            if [[ "${TAG_NAME}" != *"beta"* ]]; then
              docker buildx imagetools create -t ${IMAGE}:latest \
                ${IMAGE}:latest-amd64 \
                ${IMAGE}:latest-arm64
            fi
          else
            # é tag è§¦å‘ï¼Œåªåˆ›å»º dev ç‰ˆæœ¬
            DEV_TAG="dev-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

            docker buildx imagetools create -t ${IMAGE}:${DEV_TAG} \
              ${IMAGE}:${DEV_TAG}-amd64 \
              ${IMAGE}:${DEV_TAG}-arm64
          fi

      - name: Build Summary
        run: |
          echo "### ğŸ‰ Multi-Arch Docker Image Built Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`registry.cn-beijing.aliyuncs.com/caorushizi/mediago\`" >> $GITHUB_STEP_SUMMARY
          echo "**Architectures:** amd64, arm64" >> $GITHUB_STEP_SUMMARY

          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            echo "**Tag:** ${TAG_NAME}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Available Tags:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`${TAG_NAME}\`" >> $GITHUB_STEP_SUMMARY

            if [[ "${TAG_NAME}" != *"beta"* ]]; then
              echo "- \`latest\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            DEV_TAG="dev-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
            echo "**Version:** ${DEV_TAG}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Available Tags:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`${DEV_TAG}\`" >> $GITHUB_STEP_SUMMARY
          fi

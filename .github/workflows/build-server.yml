name: Make MediaGo Docker Image

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Docker Image
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            arch: amd64
            platform: linux/amd64
          - runner: ubuntu-22.04-arm64
            arch: arm64
            platform: linux/arm64

    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - uses: pnpm/action-setup@v4
        with:
          version: "10.15.0"
          run_install: false
          standalone: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.19.5"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm release:server

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: registry.cn-beijing.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Get short SHA
        id: sha
        run: echo "SHORT_SHA=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./apps/server
          platforms: ${{ matrix.platform }}
          push: true
          tags: |
            registry.cn-beijing.aliyuncs.com/caorushizi/mediago:latest-${{ matrix.arch }}
            registry.cn-beijing.aliyuncs.com/caorushizi/mediago:${{ steps.sha.outputs.SHORT_SHA }}-${{ matrix.arch }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create-manifest:
    name: Create Multi-Arch Manifest
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: registry.cn-beijing.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Get short SHA
        id: sha
        run: echo "SHORT_SHA=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Create and push multi-arch manifest
        run: |
          IMAGE=registry.cn-beijing.aliyuncs.com/caorushizi/mediago
          SHA=${{ steps.sha.outputs.SHORT_SHA }}

          # åˆ›å»º latest æ ‡ç­¾çš„å¤šæž¶æž„é•œåƒ
          docker buildx imagetools create -t ${IMAGE}:latest \
            ${IMAGE}:latest-amd64 \
            ${IMAGE}:latest-arm64

          # åˆ›å»ºå¸¦ commit SHA çš„å¤šæž¶æž„é•œåƒ
          docker buildx imagetools create -t ${IMAGE}:${SHA} \
            ${IMAGE}:${SHA}-amd64 \
            ${IMAGE}:${SHA}-arm64

          # åŒæ—¶ä¿ç•™å®Œæ•´ SHA æ ‡ç­¾
          docker buildx imagetools create -t ${IMAGE}:${{ github.sha }} \
            ${IMAGE}:${SHA}-amd64 \
            ${IMAGE}:${SHA}-arm64

      - name: Build Summary
        run: |
          echo "### ðŸŽ‰ Multi-Arch Docker Image Built Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`registry.cn-beijing.aliyuncs.com/caorushizi/mediago:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "**Architectures:** amd64, arm64" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** ${{ steps.sha.outputs.SHORT_SHA }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Available Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ steps.sha.outputs.SHORT_SHA }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
